# 多模态人脸+指纹融合识别使用指南

## 概述

本项目实现了人脸和指纹的多模态生物识别系统，采用分离式架构：预训练单模态模型提取特征，然后训练轻量级融合模型进行联合分类。

## 核心组件

### 1. 融合模型 (core/models/fusion_model.py)

支持4种融合策略：

- **concat**: 简单特征拼接
- **attention_fusion**: 模态内注意力机制
- **cross_attention**: 跨模态注意力机制
- **tensor_fusion**: 张量融合（最复杂的交互）

### 2. 数据集 (core/datasets/fusion_dataset.py)

支持：
- 人脸-指纹配对数据加载
- 自定义映射文件 (CSV/JSON)
- 自动数据增强
- 模态特定的预处理

### 3. 训练器 (core/trainers/fusion_trainer.py)

特点：
- 冻结预训练特征提取器
- 只训练融合层参数
- 支持完整的验证流程

## 使用方法

### 1. 准备数据

确保数据目录结构如下：

```
data/
├── face/
│   └── face/
│       ├── 000/
│       │   ├── 000_0.bmp
│       │   ├── 000_1.bmp
│       │   └── ...
│       └── ...
└── fingerprint/
    └── fingerprint/
        └── organized/
            ├── 000/
            │   ├── 000_0.bmp
            │   ├── 000_1.bmp
            │   └── ...
            └── ...
```

### 2. 配置文件

使用 `configs/fusion_config.yaml` 配置训练参数：

```yaml
# 数据路径
paths:
  face_data_dir: './data/face/face'
  fingerprint_data_dir: './data/fingerprint'
  mapping_file: './data/face_fingerprint_mapping.json'  # 可选

# 模型配置
model:
  face_embedding_dim: 512
  fingerprint_embedding_dim: 256
  fusion_hidden_dim: 512
  fusion_method: 'concat'  # 选择融合策略

# 训练配置
training:
  epochs: 50
  batch_size: 32
  learning_rate: 0.001
```

### 3. 训练命令

#### 简单拼接融合
```bash
python scripts/train_fusion.py --fusion_method concat --experiment_name fusion_concat
```

#### 注意力融合
```bash
python scripts/train_fusion.py --fusion_method attention_fusion --experiment_name fusion_attention
```

#### 跨模态注意力融合
```bash
python scripts/train_fusion.py --fusion_method cross_attention --experiment_name fusion_cross_attention
```

#### 张量融合
```bash
python scripts/train_fusion.py --fusion_method tensor_fusion --experiment_name fusion_tensor
```

### 4. 推理使用

```python
import torch
from core.models import create_model

# 加载训练好的融合模型
fusion_model = create_model("fusion",
    face_embedding_dim=512,
    fingerprint_embedding_dim=256,
    num_classes=100,
    fusion_method='concat'
)

# 加载预训练的单模态模型
face_model = create_model("face", num_classes=100, embedding_dim=512, pretrained=True)
fingerprint_model = create_model("fingerprint", num_classes=100, embedding_dim=256, pretrained=True)

# 推理流程
face_img = torch.randn(1, 3, 224, 224)  # 人脸图像
fp_img = torch.randn(1, 3, 224, 224)    # 指纹图像

# 提取特征
face_features = face_model.extract_features(face_img)
fp_features = fingerprint_model.extract_features(fp_img)

# 融合分类
logits = fusion_model(face_features, fp_features)
prediction = logits.argmax(dim=1)
```

## 实验设置建议

### 消融实验

1. **单模态基线**：
   - 只用人脸：`face_model + classifier`
   - 只用指纹：`fingerprint_model + classifier`

2. **不同融合策略比较**：
   - concat vs attention_fusion vs cross_attention vs tensor_fusion

3. **特征维度实验**：
   - 不同embedding_dim的性能对比

### 超参数调优

- **学习率**: 0.001-0.01 (融合模型使用较低学习率)
- **批大小**: 16-64
- **Dropout**: 0.3-0.5
- **隐藏层维度**: 256-1024

## 性能评估

### 指标
- 准确率 (Accuracy)
- 精确率 (Precision)
- 召回率 (Recall)
- F1分数
- EER (Equal Error Rate) - 生物识别特有

### 验证策略
- 每个epoch进行验证
- 保存最佳模型检查点
- 定期保存模型用于恢复训练

## 注意事项

1. **数据对齐**: 确保人脸和指纹数据正确配对
2. **特征提取器**: 训练时冻结单模态模型参数，只训练融合层
3. **内存优化**: 融合模型参数量小，适合内存受限环境
4. **扩展性**: 易于添加新的融合策略或模态

## 故障排除

### 常见问题

1. **数据加载失败**: 检查数据目录结构和映射文件
2. **CUDA内存不足**: 减小batch_size或使用CPU训练
3. **收敛慢**: 调整学习率或检查数据质量
4. **过拟合**: 增加dropout或使用数据增强

### 调试技巧

- 使用小数据集进行快速验证
- 检查特征维度是否匹配
- 监控训练loss和验证指标
- 使用TensorBoard可视化训练过程