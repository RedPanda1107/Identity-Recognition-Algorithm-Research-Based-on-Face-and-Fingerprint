# 生物识别指标可视化使用指南

## 概述

本项目新增了完整的生物识别指标计算和可视化功能，包括错误接受率 (FAR)、错误拒绝率 (FRR)、ROC曲线、DET曲线等。所有图表按人脸/指纹/融合模态分类，并按训练批次存放历史记录。

## 新增功能

### 1. 生物识别指标
- **错误接受率 (FAR)**: 错误接受非授权用户的概率
- **错误拒绝率 (FRR)**: 错误拒绝授权用户的概率
- **等错误率 (EER)**: FAR = FRR时的阈值点
- **ROC曲线和AUC**: 分类性能评估曲线

### 2. 可视化图表类型
- 训练曲线图 (Loss/Accuracy)
- ROC曲线
- 检测误差权衡曲线 (DET)
- FAR/FRR随阈值变化曲线
- 学习率变化曲线
- 生物识别指标演化曲线
- 跨模态性能对比图

## 文件组织结构

```
logs/
├── face/                          # 人脸模态
│   └── [experiment_name]/         # 实验名称
│       ├── training_history.json  # 训练历史数据
│       └── biometric_results/     # 生物识别结果
│           ├── epoch_1_biometric.json
│           └── epoch_2_biometric.json
├── fingerprint/                   # 指纹模态
│   └── [experiment_name]/
└── fusion/                        # 融合模态
    └── [experiment_name]/

visualization_results/             # 可视化结果
├── face/
│   └── [experiment_name]/
│       ├── training_curves_*.png
│       ├── roc_curves_*.png
│       ├── det_curves_*.png
│       └── biometric_evolution_*.png
├── fingerprint/
├── fusion/
└── comparisons/                   # 跨模态对比
    ├── accuracy_comparison_*.png
    └── biometric_comparison_*.png
```

## 使用方法

### 1. 训练时自动记录指标

训练脚本会自动记录生物识别指标，无需额外配置：

```bash
# 训练人脸识别模型
python scripts/train_face.py --config configs/face_config.yaml --experiment_name face_exp_001

# 训练指纹识别模型
python scripts/train_fingerprint.py --experiment_name fingerprint_exp_001

# 训练融合模型
python scripts/train_fusion.py --experiment_name fusion_exp_001
```

### 2. 评估已训练模型

使用evaluate.py对训练好的模型进行全面评估：

```bash
# 评估人脸模型
python scripts/evaluate.py --model_type face --checkpoint_path checkpoints/face/best_epoch_10.pth --experiment_name face_eval_001

# 评估指纹模型
python scripts/evaluate.py --model_type fingerprint --checkpoint_path checkpoints/fingerprint/best_epoch_7.pth --experiment_name fingerprint_eval_001

# 评估融合模型
python scripts/evaluate.py --model_type fusion --checkpoint_path checkpoints/fusion/best_epoch_5.pth --experiment_name fusion_eval_001
```

### 3. 生成可视化图表

使用visualize.py从训练历史数据生成各种图表：

```bash
# 生成所有模态的图表
python scripts/visualize.py --logs_dir ./logs --output_dir ./visualization_results --modalities face fingerprint fusion --generate_comparison

# 只生成人脸相关的图表
python scripts/visualize.py --logs_dir ./logs --output_dir ./face_visualization --modalities face --experiment_pattern "face_*"

# 生成特定实验的图表
python scripts/visualize.py --logs_dir ./logs --output_dir ./specific_results --experiment_pattern "*exp_001*"
```

## 脚本参数说明

### evaluate.py 参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `--model_type` | str | 是 | 模型类型: face/fingerprint/fusion |
| `--checkpoint_path` | str | 是 | 模型检查点文件路径 |
| `--experiment_name` | str | 否 | 实验名称，默认为"evaluation" |
| `--device` | str | 否 | 计算设备，默认为"auto" |

### visualize.py 参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `--logs_dir` | str | 否 | 日志目录，默认为"./logs" |
| `--modalities` | list | 否 | 要处理的模态，默认为所有模态 |
| `--experiment_pattern` | str | 否 | 实验名称匹配模式，支持通配符 |
| `--output_dir` | str | 否 | 输出目录，默认为"./visualization_results" |
| `--generate_comparison` | flag | 否 | 是否生成跨模态对比图表 |

## 输出文件说明

### 训练历史数据 (training_history.json)
```json
{
  "experiment_name": "face_exp_001",
  "model_type": "face",
  "start_time": "2025-01-17 10:00:00",
  "epochs": [
    {
      "epoch": 1,
      "train_loss": 5.6779,
      "train_acc": 0.0130,
      "val_loss": 13.4487,
      "val_acc": 0.0170,
      "learning_rate": 0.001,
      "biometric_metrics": {
        "eer": 0.4502,
        "auc": 0.5234
      }
    }
  ]
}
```

### 生物识别指标 (biometric_results/epoch_X_biometric.json)
```json
{
  "class_0": {
    "far": [0.0, 0.1, 0.2, ...],
    "frr": [1.0, 0.8, 0.6, ...],
    "thresholds": [0.9, 0.8, 0.7, ...],
    "eer": 0.234,
    "auc": 0.856
  },
  "macro_avg": {
    "eer": 0.245,
    "auc": 0.834
  }
}
```

### 可视化图表
- `training_curves_*.png`: 训练损失和准确率曲线
- `roc_curves_*.png`: ROC曲线
- `det_curves_*.png`: 检测误差权衡曲线
- `far_frr_curves_*.png`: FAR/FRR随阈值变化曲线
- `learning_rate_*.png`: 学习率变化曲线
- `biometric_evolution_*.png`: 生物识别指标演化曲线

## 注意事项

1. **依赖要求**: 确保安装了numpy, matplotlib, seaborn, sklearn
2. **内存使用**: 大数据集的生物识别指标计算可能需要较多内存
3. **计算时间**: DET曲线和ROC曲线的生成可能需要一些时间
4. **文件权限**: 确保输出目录有写入权限

## 示例工作流

```bash
# 1. 训练模型
python scripts/train_face.py --experiment_name face_baseline

# 2. 评估模型性能
python scripts/evaluate.py --model_type face --checkpoint_path checkpoints/face/best_epoch_10.pth --experiment_name face_baseline_eval

# 3. 生成可视化图表
python scripts/visualize.py --generate_comparison

# 4. 查看结果
# 图表保存在 ./visualization_results/face/face_baseline_eval/
# 对比图表保存在 ./visualization_results/comparisons/
```

## 故障排除

### 常见问题

1. **ImportError**: 确保项目根目录在Python路径中
2. **FileNotFoundError**: 检查配置文件和检查点路径是否正确
3. **MemoryError**: 减小batch_size或使用更小的验证集
4. **AUC计算警告**: 这是正常的，忽略即可

### 调试建议

- 使用 `--experiment_pattern "*test*"` 来处理测试实验
- 检查 `logs/[modality]/[experiment]/training_history.json` 是否存在
- 查看控制台输出的生物识别指标计算状态